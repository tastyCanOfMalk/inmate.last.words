---
title: 'Last words of Texas death row inmates'
subtitle: 'An exploratory text analysis'
author: 'Edward Yu'
date: '2019-03-23'
output:
  html_document:
      theme: flatly
      highlight: tango
      toc: true
      toc_float:
        collapsed: true
      toc_depth: 3
      df_print: paged
      code_folding: show
      # fig_width: 7
      # fig_height: 6
      # fig_caption: true
      # citation_package: natbib
# bibliography: bib.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo    = TRUE,
                      error   = FALSE,
                      message = FALSE,
                      warning = FALSE)

if(!require(tidyverse)) install.packages("tidyverse")
library(tidyverse)
if(!require(naniar)) install.packages("naniar")
library(naniar) # gg_miss
if(!require(mice)) install.packages("mice")
library(mice) # gg_miss
if(!require(ggridges)) install.packages("ggridges")
library(ggridges)
if(!require(viridis)) install.packages("viridis")
library(viridis)
if(!require(gridExtra)) install.packages("gridExtra")
library(gridExtra)

# clear history
rm(list = ls())

# setwd("I:/Code-CAD/R/inmate.last.words")
setwd("D:/Code/R/inmate.last.words")
```

# Introduction
I found this data via a Kaggle post: https://www.kaggle.com/mykhe1097/last-words-of-death-row-inmates. The original data was taken from: https://www.tdcj.texas.gov/death_row/dr_executed_offenders.html.  

The title alone merits more than a passing glance. Moving forward I'll start with a very simple, generalized analysis, moving on to a more in depth sentiment analysis utilizing the tidytext package.

# Import
In general, my initial process is very similar from project to project: import the data, `glimpse` and `summary` to get an idea of the structure, sort all variables by descending unique levels, and plot the missingness of each variable. I find that even if this information isn't specifically useful in every case it gives a nice overview of the data.  

At this point I can already tell that I'm going to drop the more specific `HispanicVictim` or `BlackVictim` variables in favor of the more generalized `NumberVictim`. The `AgeWhenReceived` variable also sounds like it could be an interesting variable to work with paired with `Race` or `Age`.  

```{r}
# import
x <- read_csv("data/Texas Last Statement - CSV.csv")

glimpse(x)
summary(x)

# Find unique levels
x.levels <- cbind(colnames(x),
                  (as.data.frame(sapply(x,function(x) length(unique(x))))))
colnames(x.levels) <- c("var","levels")
row.names(x.levels) <- NULL
x.levels[order(-x.levels[,2]),]

# % missingness using naniar package
gg_miss_var(x, show_pct = T)
```

# Impute
As mentioned before, I'm only interested in some of the data, no use imputing data I'm not going to analyze. I'll keep:  

  1. First name
  2. Last name
  3. Race
  4. Education level
  5. Previous crime commited?
  6. Number of victims
  7. Number of female victims
  8. Number of male victims
  9. Age when received
  10. Age executed
  11. Codefendants
  12. Last statement

My first analyses used simple median or mean values to replace NA's. This time around I've become interested in a package called `mice`, which stands for Multivariate Imputation by Chained Equations. As my familiarity with the package is limitesd at this time, I followed the following reference quite closely: https://www.r-bloggers.com/imputing-missing-data-with-r-mice-package/.  

First, a couple columns are renamed, columns of interest are then selected.  
The imputation process is performed on only numeric data, at first, so that visualization is smoother. 
```{r results='hide'}
# rename columns, select columns of interest
x1 <- x %>% 
  mutate(AWR = AgeWhenReceived) %>% 
  mutate(AgeExec = Age) %>% 
  select(FirstName, 
         LastName, 
         Race, 
         EducationLevel,
         PreviousCrime, 
         NumberVictim, 
         FemaleVictim, 
         MaleVictim, 
         AWR,
         AgeExec, 
         Codefendants, 
         LastStatement)

# remove columns with characters for stripplot() visualization
rem <- c(1,2,3,12)

# imputation process using pmm, 20 iterations
tempData <- mice(x1[-rem],
                 maxit=20,
                 meth='pmm',
                 seed=1)

# compare distribution of actual values with imputed values; red=imputed
xyplot(tempData,
       AWR~
         PreviousCrime+
         EducationLevel+
         FemaleVictim+
         MaleVictim+
         NumberVictim+
         Codefendants,
       pch=18,
       cex=1)

# can also compare using density plot; red=imputed
densityplot(tempData)

# and stripplot
stripplot(tempData,pch=20,cex=1)

# rerun imputation on complete dataset and compare to original
tempData <- mice(x1,m=5,maxit=50,meth='pmm')

# replace missing values with imputed values using first dataset
xCom <- complete(tempData,1)
```

Although we already saw above that imputed data fell within reasonable ranges, checking the `summary` data of the original dataset and comparing to the new, imputed dataset gives a little peace of mind.  

```{r}
# comparing the completed data to the original again shows imputed data makes sense
summary(xCom)[,-rem]
summary(x1)[,-rem]
```

# EDA
We're ready to do some exploratory data analysis at this point. What I'm interested are probably the most obvious things:

  * Age received vs race

## Time served measurement
Before going too far I want to add a time served, or `Served` measurement. Upon doing this an error in the data presents itself pretty plainly in the `summary` measure reporting a value of -1.  

If we track this value down we can conclude that either the Age when received or the Age when executed measures are incorrect. Since the median value of our newly created time served variable is equal to 10, it's safe to assume that either our `AWR` should be 27, rather than 37; or `AgeExec` should be 46, rather than 36.  

  
```{r}
# add time served column
xCom <- xCom %>% 
  mutate(Served = AgeExec-AWR)

# have an odd -1 years served
summary(xCom$Served)

# find datapoint
which.min(xCom$Served)
xCom[266,]
```

It turns out that a simple internet search of the inmate's name leads us to the actual age of execution being 47 rather than 37: http://www.clarkprosecutor.org/html/death/US/walker796.htm.
```{r}
# change AgeExec and Served for 266
xCom[266,]$AgeExec <- 47
xCom[266,]$Served <- 10
```

## Race vs time
Does race play a part in how many years are served leading up to the execution date? Based on summary data it seems that time served is roughly the same for all races. We put the relative and absolute graphs together to show that whites and blacks were executed more than hispanics.

```{r}
# check races, remove other when plotting
summary(as.factor(x$Race))

xCom %>% 
  filter(Race != "Other") %>% 
  group_by(Race) %>% 
  summarise(median(Served))

g1 <- xCom %>% 
  filter(Race != "Other") %>% 
  ggplot(aes(x=Served,fill=Race))+
  geom_density(alpha=.8)+
  ggtitle("Time served by race (relative)")

g2 <- xCom %>% 
  filter(Race != "Other") %>% 
  ggplot(aes(x=Served,fill=Race))+
  geom_histogram()+
  facet_wrap(Race~.)+
  ggtitle("Time served by race (absolute)")

grid.arrange(g1,g2,nrow=1)
```

Though time served is relatively constant between races, we can definitely see some differences regarding when inmates were received. In general, whites are received roughly 4 years later when compared to blacks or hispanics.  

```{r}
# race vs median AWR
xCom %>% 
  filter(Race != "Other") %>% 
  group_by(Race) %>% 
  summarise(median(AWR))

# Age received vs race
p1 <- xCom %>% 
  filter(Race != "Other") %>% 
  ggplot(aes(x=AWR,y=Race,fill=..density..))+
  geom_density_ridges_gradient(scale=1.5,rel_min_height=.01)+
  scale_x_continuous(limits=c(10,70),
                     breaks=c(seq(15,70,5)))+
  ggtitle("Age when received by race")+
  xlab("Age when received")+
  theme(legend.position="none")+
  scale_fill_viridis(option="D")

# Age executed vs race
p2 <- xCom %>% 
  filter(Race != "Other") %>% 
  ggplot(aes(x=AgeExec,y=Race,fill=..density..))+
  geom_density_ridges_gradient(scale=1.5,rel_min_height=.01)+
  scale_x_continuous(limits=c(10,70),
                     breaks=c(seq(15,70,5)))+
  ggtitle("Age of execution by race")+
  xlab("Age when executed")+
  theme(legend.position="none")+
  scale_fill_viridis(option="D")

grid.arrange(p1,p2,nrow=1)
```

## Number of victims vs
Does anything change when the number of victims increases? It's a bit difficult to make concrete conclusions based on such little data. We can see pretty quickly that most inmates had a single victim. Time served does not seem to fluctuate much based solely on the number of victims: the median seems to stay within the 10 year range we saw before.

```{r}
# does time served change as number of victims change?
p3 <- xCom %>% 
  # filter(NumberVictim > 0 & NumberVictim < 6) %>% 
  ggplot(aes(x=Served,fill=as.factor(NumberVictim)))+
  geom_histogram(stat="count")+
  # facet_wrap(NumberVictim~.,nrow=3)+
  ggtitle("Histogram of years served, fill = NumberVictim")+
  theme(legend.position = "none")+
  scale_fill_brewer(type="qual",palette=3)

# try boxplot instead with numbervictims = box
p4 <- xCom %>% 
  as_tibble() %>% 
  select(Served, NumberVictim) %>% 
  ggplot(aes(y=Served,x=as.factor(NumberVictim)))+
  geom_boxplot(outlier.color = NA)+
  coord_flip()+
  geom_jitter(width=.2,alpha=.4,aes(color=as.factor(NumberVictim)))+
  theme(legend.position = "none")+
  ggtitle("Number of victims vs Served")+
  scale_color_brewer(type="qual",palette=3)+
  xlab("NumberVictim")

grid.arrange(p3,p4,nrow=1)

```

Education level is also relatively constant throughout the range of inmates. In the standard histogram we see a huge dropoff after education level 12 (assumedly High School, grade 12). In fact, our largest peaks occur between grades 9-12, indicating that not completing high school has a potentially significant impact on becoming a deathrow inmate.  

When comparing the number of victims to education level, however, we do not see much of a relationship.  

```{r}
# education level vs number of victims
e1 <- xCom %>% 
  # filter(NumberVictim > 0 & NumberVictim < 6) %>%
  ggplot(aes(x=EducationLevel,fill=as.factor(NumberVictim)))+
  geom_histogram(stat="count")+
  # facet_wrap(NumberVictim~.,nrow=2)+
  ggtitle("Histogram of education level, fill = NumberVictim")+
  scale_fill_brewer(type="qual",palette=3)+
  theme(legend.position = "none")

e2 <- xCom %>% 
  # as_tibble() %>% 
  # select(Served, NumberVictim) %>% 
  ggplot(aes(y=EducationLevel,x=as.factor(NumberVictim)))+
  geom_boxplot(outlier.color = NA)+
  coord_flip()+
  geom_jitter(width=.2,alpha=.4,aes(color=as.factor(NumberVictim)))+
  theme(legend.position = "none")+
  ggtitle("Number of victims vs Served")+
  scale_color_brewer(type="qual",palette=3)+
  xlab("NumberVictim")

grid.arrange(e1,e2,nrow=1)
```

