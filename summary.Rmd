---
title: 'Last words of Texas death row inmates'
subtitle: 'An exploratory text analysis'
author: 'Edward Yu'
date: '2019-03-23'
output:
  html_document:
      theme: flatly
      highlight: tango
      toc: true
      toc_float:
        collapsed: true
      toc_depth: 3
      df_print: paged
      code_folding: show
      # fig_width: 7
      # fig_height: 6
      # fig_caption: true
      # citation_package: natbib
# bibliography: bib.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo    = TRUE,
                      error   = FALSE,
                      message = FALSE,
                      warning = FALSE)

if(!require(tidyverse)) install.packages("tidyverse")
library(tidyverse)
if(!require(naniar)) install.packages("naniar")
library(naniar) # gg_miss
if(!require(mice)) install.packages("mice")
library(mice) # gg_miss
if(!require(ggridges)) install.packages("ggridges")
library(ggridges)
if(!require(viridis)) install.packages("viridis")
library(viridis)
if(!require(gridExtra)) install.packages("gridExtra")
library(gridExtra)
if(!require(ggalt)) install.packages("ggalt")
library(ggalt)

# clear history
rm(list = ls())

# setwd("I:/Code-CAD/R/inmate.last.words")
setwd("D:/Code/R/inmate.last.words")
```

# Introduction
I found this data via a Kaggle post: https://www.kaggle.com/mykhe1097/last-words-of-death-row-inmates. The original data was taken from: https://www.tdcj.texas.gov/death_row/dr_executed_offenders.html.  

The title alone was interesting enough to merit more than a passing glance. I'll start with a very simple, generalized analysis, moving on to a more in depth sentiment analysis utilizing the tidytext package.

# Import
In general, my initial process is very similar from project to project: import the data, use `glimpse` and `summary` to get an idea of the structure, sort all variables by descending unique levels, and plot the missingness of each variable. I find that even if this information isn't specifically useful in every case it gives a nice overview of the data.  

```{r}
# import
x <- read_csv("data/Texas Last Statement - CSV.csv")

glimpse(x)
summary(x)

# Find unique levels
x.levels <- cbind(colnames(x),
                  (as.data.frame(sapply(x,function(x) length(unique(x))))))
colnames(x.levels) <- c("var","levels")
row.names(x.levels) <- NULL
x.levels[order(-x.levels[,2]),]

# % missingness using naniar package
gg_miss_var(x, show_pct = T)
```

At this point I can already tell that I'm going to drop the more specific `HispanicVictim` or `BlackVictim` variables in favor of the more generalized `NumberVictim` variable. The `AgeWhenReceived` variable also sounds like it could be an interesting variable to work with paired with `Race` or `Age`. 

# Impute
I'll start by listing all the variables I might be interested in working with.  

  1. First name
  2. Last name
  3. Race
  4. Education level
  5. Previous crime commited?
  6. Number of victims
  7. Number of female victims
  8. Number of male victims
  9. Age when received
  10. Age executed
  11. Codefendants
  12. Last statement

Generally we only impute if 5% or less of the data is missing. In this case, `EducationLevel`, `PreviousCrime`, `Codefendants`, are all missing more than 5% of their data. In this case, and for the sake of exploration, I will bend the rule and attempt imputation regardless.  

My first analyses used simple median or mean values to replace NA's. This time around I've become interested in a package called `mice`, which stands for Multivariate Imputation by Chained Equations. As my familiarity with the package is limited at this time, I followed the following reference quite closely: https://www.r-bloggers.com/imputing-missing-data-with-r-mice-package/.  

The visualizations that follow show the imputed (red) values falling well within actual (blue) values, indicating the imputation was reasonable.  

```{r results='hide'}
# rename columns, select columns of interest
x1 <- x %>% 
  mutate(AWR = AgeWhenReceived) %>% 
  mutate(AgeExec = Age) %>% 
  select(FirstName, 
         LastName, 
         Race, 
         EducationLevel,
         PreviousCrime, 
         NumberVictim, 
         FemaleVictim, 
         MaleVictim, 
         AWR,
         AgeExec, 
         Codefendants, 
         LastStatement)

# remove columns with characters for stripplot() visualization
rem <- c(1,2,3,12)

# imputation process using pmm, 20 iterations
tempData <- mice(x1[-rem],
                 m=1,
                 maxit=20,
                 meth='pmm',
                 seed=1)

# compare distribution of actual values with imputed values; red=imputed
xyplot(tempData,
       AWR~
         PreviousCrime+
         EducationLevel+
         FemaleVictim+
         MaleVictim+
         NumberVictim+
         Codefendants,
       pch=18,
       cex=1)

# can also compare using density plot; red=imputed
densityplot(tempData)

# and stripplot
stripplot(tempData,pch=20,cex=1)

# rerun imputation on complete dataset and compare to original
tempData <- mice(x1,m=1,maxit=50,meth='pmm',seed=1)

# replace missing values with imputed values using first dataset
xCom <- complete(tempData,1)
```

Checking the `summary` data of the original dataset and comparing to the new, imputed dataset confirms that our imputed data falls within the distribution of our original data.  

```{r}
# comparing the completed data to the original again shows imputed data makes sense
summary(xCom)[,-rem]
summary(x1)[,-rem]
```

# Time served measurement
I wanted to add a time served, or `Served` measurement. Upon doing this an error in the data presented itself plainly in the `summary` measure which reporeted a value of -1.  

```{r}
# add time served column
xCom <- xCom %>% 
  mutate(Served = AgeExec-AWR)

# have an odd -1 years served
summary(xCom$Served)

# find datapoint
which.min(xCom$Served)
xCom[266,]
```

If we track this value down we can conclude that either the Age when received or the Age when executed measures are incorrect. Since the median value of our newly created time served variable is equal to 10, it's safe to assume that either our `AWR` should be 27, rather than 37; or `AgeExec` should be 46, rather than 36.  

It turns out that a simple internet search of the inmate's name leads us to the actual age of execution being 47 rather than 37: http://www.clarkprosecutor.org/html/death/US/walker796.htm.

```{r}
# change AgeExec and Served for 266
xCom[266,]$AgeExec <- 47
xCom[266,]$Served <- 10
```

# EDA
We're ready to do some exploratory data analysis at this point. What I'm interested in are probably cliche points of analysis but given the variables presented they seem to stand out.  

  * Race vs Time served
  * Race vs Age when received

## Race vs time served
Does race play a part in how many years are served leading up to the execution date? Based on summary data it seems that time served is roughly the same for all races. We can plot density and histogram plots to show the relative and absolute differences in time served between races.  

Note there were 2 races classified as `Other`, which were removed.  

```{r}
# check races, remove 'other' when plotting
summary(as.factor(x$Race))

xCom %>% 
  filter(Race != "Other") %>% 
  group_by(Race) %>% 
  summarise(median(Served))

g1 <- xCom %>% 
  filter(Race != "Other") %>% 
  ggplot(aes(x=Served,fill=Race))+
  geom_density(alpha=.8)+
  ggtitle("Time served by race (relative)")

g2 <- xCom %>% 
  filter(Race != "Other") %>% 
  ggplot(aes(x=Served,fill=Race))+
  geom_histogram()+
  facet_wrap(Race~.)+
  ggtitle("Time served by race (absolute)")

grid.arrange(g1,g2,nrow=1)
```

We see clearly, based on the density plot, that time served between the different races represented are very similar. When we look at the histogram we do notice there are far fewer hispanics and appear to be slightly more whites in this population.

## Race vs age when received/executed
What can we discover about when the inmates were first received and how race impacts this?  Along the same vein, does age of execution remain similar between races?  

```{r}
# Age received, executed, served by race
xCom %>% 
  filter(Race != "Other") %>% 
  group_by(Race) %>% 
  summarise(AWR=median(AWR),
            AgeExec=median(AgeExec),
            Served=median(Served))

# dumbell summary
df.db <- xCom %>% 
  filter(Race != 'Other') %>% 
  group_by(Race) %>% 
  summarise(AWR=median(AWR),
            AgeExec=median(AgeExec),
            Served=median(Served))

df.db %>% 
  ggplot()+
  # geom_segment(aes(y=Race,yend=Race,x=0,xend=1),color="Red",size=.15)+
  geom_dumbbell(aes(y=Race, x=AWR, xend=AgeExec),
                size=5, 
                color="#e3e2e1",
                colour_x = "#5b8124", 
                colour_xend = "#bad744")+
  xlab("Age")+
  theme_bw()

# detailed boxplots of all stats
df <- xCom %>% 
  filter(Race != "Other") %>% 
  select(Race,AWR,AgeExec,Served)

df <- df %>% 
  gather(key = "Age.thingy", value = "Years", colnames(df)[2:4]) %>%
  mutate(Race = factor(Race))

ggplot(data = df, aes(x = Race, y = Years, fill = Race))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(shape=16,position=position_jitter(.15),alpha=.3)+
  coord_flip()+
  facet_wrap(~Age.thingy, nrow = 3, strip.position = "top")+
  theme_bw()
```

We see that Blacks tend to be received sooner than Hispanics, while Whites are generally received much later than both other Races. Time served before execution does remain quite similar between all races.  

## Number of victims vs
Does anything change when the number of victims increases? It's a bit difficult to make concrete conclusions based on such little data. We can see pretty quickly that most inmates had a single victim. Time served does not seem to fluctuate much based solely on the number of victims: the median seems to stay within the 10 year range we saw before.

```{r}
# does time served change as number of victims change?
p3 <- xCom %>% 
  # filter(NumberVictim > 0 & NumberVictim < 6) %>% 
  ggplot(aes(x=Served,fill=as.factor(NumberVictim)))+
  geom_histogram(stat="count")+
  # facet_wrap(NumberVictim~.,nrow=3)+
  ggtitle("Histogram of years served, fill = NumberVictim")+
  theme(legend.position = "none")+
  scale_fill_brewer(type="qual",palette=3)

# try boxplot instead with numbervictims = box
p4 <- xCom %>% 
  as_tibble() %>% 
  select(Served, NumberVictim) %>% 
  ggplot(aes(y=Served,x=as.factor(NumberVictim)))+
  geom_boxplot(outlier.color = NA)+
  coord_flip()+
  geom_jitter(width=.2,alpha=.4,aes(color=as.factor(NumberVictim)))+
  theme(legend.position = "none")+
  ggtitle("Number of victims vs Served")+
  scale_color_brewer(type="qual",palette=3)+
  xlab("NumberVictim")

grid.arrange(p3,p4,nrow=1)

```

Education level is also relatively constant throughout the range of inmates. In the standard histogram we see a huge dropoff after education level 12 (assumedly High School, grade 12). In fact, our largest peaks occur between grades 9-12, indicating that not completing high school has a potentially significant impact on becoming a deathrow inmate.  

When comparing the number of victims to education level, however, we do not see much of a relationship.  

```{r}
# education level vs number of victims
e1 <- xCom %>% 
  # filter(NumberVictim > 0 & NumberVictim < 6) %>%
  ggplot(aes(x=EducationLevel,fill=as.factor(NumberVictim)))+
  geom_histogram(stat="count")+
  # facet_wrap(NumberVictim~.,nrow=2)+
  ggtitle("Histogram of education level, fill = NumberVictim")+
  scale_fill_brewer(type="qual",palette=3)+
  theme(legend.position = "none")

e2 <- xCom %>% 
  # as_tibble() %>% 
  # select(Served, NumberVictim) %>% 
  ggplot(aes(y=EducationLevel,x=as.factor(NumberVictim)))+
  geom_boxplot(outlier.color = NA)+
  coord_flip()+
  geom_jitter(width=.2,alpha=.4,aes(color=as.factor(NumberVictim)))+
  theme(legend.position = "none")+
  ggtitle("Number of victims vs Served")+
  scale_color_brewer(type="qual",palette=3)+
  xlab("NumberVictim")

grid.arrange(e1,e2,nrow=1)
```

